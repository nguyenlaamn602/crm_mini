{% extends "base.html" %}

{% block title %}Pricing Tool - HUB THG{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0 text-primary">
                <i class="bi bi-calculator me-2"></i>Pricing Tool
            </h4>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="toggleHistory()">
                <i class="bi bi-clock-history me-1"></i> History
            </button>

            <a href="{{ url_for('download_template') }}" class="btn btn-outline-success">
                <i class="bi bi-download me-1"></i> Download Template
            </a>

            <span class="badge bg-light text-dark border">
                <i class="bi bi-calendar3 me-1"></i>
                {% if now_dt is defined and now_dt %}
                {{ now_dt().strftime('%d/%m/%Y') }}
                {% else %}
                Today
                {% endif %}
            </span>
        </div>
    </div>

    <!-- ========================= -->
    <!-- PRICING HISTORY PANEL -->
    <!-- ========================= -->
    <div id="history-panel" class="card border-0 shadow-sm mb-4 d-none">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">
                <i class="bi bi-clock-history me-2"></i>Pricing History
            </h6>
            <button class="btn btn-sm btn-light border" onclick="toggleHistory()">Close</button>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th width="50">#</th>
                            <th>Time</th>
                            <th>Mode</th>
                            <th class="text-center">Rows</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                Click <b>History</b> to load data.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- VIEW 1: SELECTION SCREEN -->
    <!-- ========================= -->
    <div id="selection-view" class="py-4">
        <div class="row g-4 justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="card h-100 border-0 shadow-sm text-center card-hover cursor-pointer"
                    onclick="startWorkflow('Pricing China-WW')">
                    <div class="card-body py-5 bg-info bg-opacity-10 rounded text-info-emphasis">
                        <i class="bi bi-globe-asia-australia display-1 mb-3"></i>
                        <h3 class="fw-bold">Pricing China-WW</h3>
                    </div>
                </div>
            </div>

            <div class="col-md-5 col-lg-4">
                <div class="card h-100 border-0 shadow-sm text-center card-hover cursor-pointer"
                    onclick="startWorkflow('Pricing VN-WW')">
                    <div class="card-body py-5 bg-success bg-opacity-10 rounded text-success-emphasis">
                        <i class="bi bi-geo-alt display-1 mb-3"></i>
                        <h3 class="fw-bold">Pricing VN-WW</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- WORKFLOW VIEW -->
    <!-- ========================= -->
    <div id="workflow-view" class="d-none">
        <div class="mb-4 d-flex align-items-center">
            <button class="btn btn-light border me-3" onclick="resetView()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <h4 class="mb-0 fw-bold" id="workflow-title">Processing...</h4>
        </div>

        <!-- STEP 1 -->
        <div class="card mb-4 border-0 shadow-sm" id="step-1-data">
            <div class="card-header bg-white">
                <h6 class="fw-bold text-primary mb-0">
                    <i class="bi bi-1-circle-fill me-2"></i>Step 1: Import Order Data
                </h6>
            </div>
            <div class="card-body">
                <form id="uploadDataForm" enctype="multipart/form-data" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <input class="form-control" type="file" id="dataFile" accept=".xlsx,.xls,.csv" required>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="bi bi-upload me-1"></i> Upload
                        </button>
                    </div>
                </form>
                <div id="data-status" class="small mt-2 text-muted"></div>
            </div>
        </div>

        <!-- STEP 2 -->
        <div class="card mb-4 border-0 shadow-sm d-none" id="step-2-price">
            <div class="card-header bg-white">
                <h6 class="fw-bold text-success mb-0">
                    <i class="bi bi-2-circle-fill me-2"></i>Step 2: Import Price Table
                </h6>
            </div>
            <div class="card-body">
                <form id="uploadPriceForm" enctype="multipart/form-data" class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <input class="form-control" type="file" id="priceFile" accept=".xlsx,.xls" required>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" type="submit">
                            <i class="bi bi-cloud-upload me-1"></i> Upload
                        </button>
                    </div>
                </form>
                <div id="priceResult" class="mt-2 small"></div>
            </div>
        </div>

        <!-- STEP 3 -->
        <div class="card border-0 shadow-sm d-none" id="step-3-result">
            <div class="card-header bg-white d-flex justify-content-between">
                <h6 class="fw-bold mb-0">
                    <i class="bi bi-table me-2"></i>Data & Results
                </h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-warning fw-bold" id="btnCalculate" disabled>
                        <i class="bi bi-calculator-fill me-1"></i> Calculate
                    </button>
                    <button class="btn btn-info fw-bold" id="btnOpenFormulaModal" disabled>
                        <i class="bi bi-plus-slash-minus me-1"></i> Add Formula
                    </button>
                    <button class="btn btn-success fw-bold d-none" id="btnSaveHistory">
                        <i class="bi bi-save me-1"></i> Save
                    </button>
                    <button class="btn btn-outline-dark fw-bold d-none" id="btnExport">
                        <i class="bi bi-file-earmark-excel me-1"></i> Export
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:500px;overflow:auto">
                    <table class="table table-bordered mb-0 align-middle text-nowrap">
                        <thead class="table-light sticky-top" id="data-table-head"></thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FORMULA BUILDER MODAL -->
<div class="modal fade" id="formulaModal" tabindex="-1" aria-labelledby="formulaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formulaModalLabel">Add Formula Column</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <ul class="nav nav-tabs nav-fill" id="formulaTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="new-formula-tab" data-bs-toggle="tab"
                            data-bs-target="#new-formula-pane" type="button" role="tab">Add Formula</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="lookup-tab" data-bs-toggle="tab" data-bs-target="#lookup-pane"
                            type="button" role="tab">
                            <i class="bi bi-search me-1"></i>Lookup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="saved-formula-tab" data-bs-toggle="tab"
                            data-bs-target="#saved-formula-pane" type="button" role="tab">Saved Formulas</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="blank-column-tab" data-bs-toggle="tab"
                            data-bs-target="#blank-column-pane" type="button" role="tab">Blank Column</button>
                    </li>
                </ul>
                <div class="tab-content p-4" id="formulaTabContent">
                    <!-- Pane 1: Add New Formula -->
                    <div class="tab-pane fade show active" id="new-formula-pane" role="tabpanel">
                        <div class="mb-3">
                            <label for="newColumnName" class="form-label">New Column Name</label>
                            <input type="text" class="form-control" id="newColumnName" placeholder="e.g., Total Fee">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Formula</label>
                            <div id="formulaInput" class="form-control" style="min-height: 80px;"
                                contenteditable="true"></div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small text-muted">Operators:</label>
                            <div class="d-flex flex-wrap gap-2" id="formula-operators">
                                <button class="btn btn-sm btn-outline-secondary" data-value="+">+</button>
                                <button class="btn btn-sm btn-outline-secondary" data-value="-">-</button>
                                <button class="btn btn-sm btn-outline-secondary" data-value="*">*</button>
                                <button class="btn btn-sm btn-outline-secondary" data-value="/">/</button>
                                <button class="btn btn-sm btn-outline-secondary" data-value="(">(</button>
                                <button class="btn btn-sm btn-outline-secondary" data-value=")">)</button>
                                <button class="btn btn-sm btn-outline-danger" id="formula-clear">Clear</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Columns:</label>
                            <div class="d-flex flex-wrap gap-2" id="formula-columns"></div>
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-primary" id="applyFormula">Apply New Formula</button>
                        </div>
                    </div>
                    <!-- Pane 2: Apply Saved Formula -->
                    <div class="tab-pane fade" id="saved-formula-pane" role="tabpanel">
                        <p class="text-muted small">Click "Apply" to add a saved formula as a new column.</p>
                        <div id="saved-formulas-container"></div>
                    </div>
                    <!-- ✅ NEW Pane 3: Lookup from History (Simplified) -->
                    <div class="tab-pane fade" id="lookup-pane" role="tabpanel">
                        <p class="text-muted small mb-3">Lookup values from a historical table based on matching
                            columns.</p>

                        <!-- Step 1: New Column Name -->
                        <div class="mb-3">
                            <label class="form-label fw-bold"><span class="badge bg-primary me-2">1</span>New Column
                                Name</label>
                            <input type="text" class="form-control" id="lookupNewColumnName"
                                placeholder="e.g., Old Price">
                        </div>

                        <!-- Step 2: Select History Table -->
                        <div class="mb-3">
                            <label class="form-label fw-bold"><span class="badge bg-primary me-2">2</span>Select History
                                Table</label>
                            <select class="form-select" id="lookupHistorySelect">
                                <option value="">-- Select a history table --</option>
                            </select>
                        </div>

                        <!-- Step 3: Match Column (Simplified - auto-match by name) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold"><span class="badge bg-primary me-2">3</span>Match
                                Column</label>
                            <select class="form-select" id="lookupCurrentKey">
                                <option value="">-- Select column from current table --</option>
                            </select>
                            <div id="lookupMatchStatus" class="mt-2"></div>
                            <small class="text-muted">Will auto-match with same-named column in history table.</small>
                        </div>

                        <!-- Step 4: Get Value Column -->
                        <div class="mb-3">
                            <label class="form-label fw-bold"><span class="badge bg-primary me-2">4</span>Get Value From
                                (History)</label>
                            <select class="form-select" id="lookupHistoryValue">
                                <option value="">-- Select column to get value --</option>
                            </select>
                            <small class="text-muted">This column's value will be copied to the new column.</small>
                        </div>

                        <div class="text-end mt-4">
                            <button type="button" class="btn btn-success btn-lg" id="applyLookupBtn">
                                <i class="bi bi-search me-2"></i>Apply Lookup
                            </button>
                        </div>
                    </div>
                    <!-- Pane 4: Add Blank Column -->
                    <div class="tab-pane fade" id="blank-column-pane" role="tabpanel">
                        <p class="text-muted small">This will add a new, empty column to your table. You can then fill
                            data manually and use the drag-to-fill handle.</p>
                        <div class="mb-3">
                            <label for="blankColumnName" class="form-label">New Blank Column Name</label>
                            <input type="text" class="form-control" id="blankColumnName"
                                placeholder="e.g., Manual Notes">
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-primary" id="addBlankColumnBtn">Add Blank
                                Column</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JOIN/COMPARE MODAL -->
<div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="joinModalLabel">Compare with History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Select the common column (key) to join the current data with the historical
                    data.</p>
                <div class="mb-3">
                    <label for="joinKeyCurrent" class="form-label">Key in **Current Data**</label>
                    <select class="form-select" id="joinKeyCurrent"></select>
                </div>
                <div class="mb-3">
                    <label for="joinKeyHistory" class="form-label">Key in **History Data**</label>
                    <select class="form-select" id="joinKeyHistory"></select>
                </div>
                <div class="mb-3">
                    <label for="historyPrefix" class="form-label">Prefix for history columns</label>
                    <input type="text" class="form-control" id="historyPrefix" value="history_">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyJoin">Join Data</button>
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer {
        cursor: pointer
    }

    .card-hover:hover {
        transform: translateY(-4px);
        transition: .2s
    }

    #formulaInput:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .editable-cell {
        position: relative;
        background-color: #fefde8 !important;
        /* Light yellow to indicate editable */
    }

    .editable-cell:focus {
        outline: 2px solid #0d6efd;
        background-color: #fff !important;
    }

    .editable-cell::after {
        content: '';
        position: absolute;
        right: 0;
        bottom: 0;
        width: 8px;
        height: 8px;
        background-color: #0d6efd;
        cursor: crosshair;
    }

    .fill-selection {
        outline: 1px dashed #0d6efd;
    }
</style>

<script>
    let currentData = [];
    let currentMode = "";
    let comparisonData = [];
    let formulaModalObj = null;
    let joinModalObj = null;
    let userAddedColumns = new Set();
    let lookupData = null;
    let lookupKey = '';
    let lookupReturn = '';

    // ✅ Helper: Format số VND với dấu chấm phân cách nghìn (1234567 → 1.234.567)
    function formatVND(value) {
        if (value === null || value === undefined || value === '') return '';
        const num = parseFloat(String(value).replace(/[,.]/g, ''));
        if (isNaN(num)) return value; // Giữ nguyên nếu không phải số
        return Math.round(num).toLocaleString('vi-VN');
    }

    // ✅ Helper: Kiểm tra cột có phải là cột tiền tệ không
    function isMoneyColumn(colName) {
        const moneyColumns = ['Cước chính', 'Phí đăng ký', 'Total', 'Tổng', 'Fee', 'Price', 'VND'];
        return moneyColumns.some(m => colName.toLowerCase().includes(m.toLowerCase()));
    }

    /* ================= HISTORY ================= */

    async function toggleHistory() {
        const panel = document.getElementById('history-panel');
        panel.classList.toggle('d-none');
        if (!panel.classList.contains('d-none')) loadHistory();
    }

    async function loadHistory() {
        const body = document.getElementById('historyTableBody');
        body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>';

        try {
            const res = await fetch('/tools/pricing/history');
            const json = await res.json();
            if (json.status !== 'success' || !json.items) {
                body.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load history.</td></tr>';
                return;
            }

            if (json.items.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No history found.</td></tr>';
                return;
            }

            body.innerHTML = '';
            json.items.forEach((h, i) => {
                const tr = document.createElement('tr');
                tr.id = `history-row-${h._id}`;
                tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${new Date(h.created_at).toLocaleString('vi-VN')}</td>
                <td>${h.name || h.mode || '-'}</td>
                <td class="text-center fw-bold">${h.total_rows}</td>
                <td class="text-end">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryDetail('${h._id}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="loadForComparison('${h._id}')">
                                <i class="bi bi-journal-plus me-2"></i>Load for Compare
                            </a></li>
                        </ul>
                    </div>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteHistoryItem('${h._id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
                body.appendChild(tr);
            });
        } catch (e) {
            body.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Network error loading history.</td></tr>';
        }
    }

    async function deleteHistoryItem(id) {
        if (!confirm('Are you sure you want to delete this history record?')) return;
        try {
            const res = await fetch('/tools/pricing/history/delete/' + id, { method: 'POST' });
            const json = await res.json();
            if (json.status === 'success') {
                document.getElementById(`history-row-${id}`).remove();
            } else {
                alert('Error deleting history: ' + (json.message || 'Unknown error'));
            }
        } catch (e) {
            alert('Network error while deleting history.');
        }
    }

    async function viewHistoryDetail(id) {
        try {
            const res = await fetch('/tools/pricing/history/' + id);
            const json = await res.json();
            if (json.status === 'success') {
                currentData = json.item.data;
                renderTable(currentData);
                document.getElementById('selection-view').classList.add('d-none');
                document.getElementById('workflow-view').classList.remove('d-none');
                document.getElementById('step-1-data').classList.add('d-none');
                document.getElementById('step-2-price').classList.add('d-none');
                document.getElementById('step-3-result').classList.remove('d-none');
                document.getElementById('workflow-title').innerText = "History: " + (json.item.mode || "Data");
                document.getElementById('btnExport').classList.remove('d-none');
                document.getElementById('btnOpenFormulaModal').disabled = false;
            }
        } catch (e) { alert("Error loading history detail."); }
    }

    // ✅ NEW: Format VND with thousand separators (1234567 -> "1.234.567")
    function formatVND(value) {
        if (value === null || value === undefined || value === '') return '';
        // Remove existing separators and parse number
        const numValue = parseFloat(String(value).replace(/[,.]/g, ''));
        if (isNaN(numValue)) return value;
        // Only format if >= 1000 (4+ digits)
        if (Math.abs(numValue) < 1000) return numValue.toString();
        // Format with dot as thousand separator (VND style)
        return numValue.toLocaleString('vi-VN').replace(/,/g, '.');
    }

    // ✅ NEW: Check if column is a money column that should be formatted
    function isMoneyColumn(colName) {
        const moneyKeywords = ['cước', 'phí', 'giá', 'price', 'fee', 'cost', 'total', 'tổng'];
        const lowerName = colName.toLowerCase();
        return moneyKeywords.some(kw => lowerName.includes(kw));
    }

    /* ================= WORKFLOW ================= */

    function startWorkflow(mode) {
        currentMode = mode;
        document.getElementById('selection-view').classList.add('d-none');
        document.getElementById('workflow-view').classList.remove('d-none');
        document.getElementById('workflow-title').innerText = mode;
        currentData = [];
        renderTable([]);
    }

    function resetView() {
        document.getElementById('workflow-view').classList.add('d-none');
        document.getElementById('selection-view').classList.remove('d-none');
        document.getElementById('step-1-data').classList.remove('d-none');
        document.getElementById('step-2-price').classList.add('d-none');
        document.getElementById('step-3-result').classList.add('d-none');
    }

    // ✅ NEW: Delete a user-added column (from formula)
    function deleteColumn(colName) {
        if (!confirm(`Delete column "${colName}"?`)) return;

        // Remove from data
        currentData.forEach(row => {
            delete row[colName];
        });

        // Remove from tracking set
        userAddedColumns.delete(colName);

        // Re-render table
        renderTable(currentData);
    }

    function renderTable(data) {
        const thead = document.getElementById('data-table-head');
        const tbody = document.getElementById('dataTableBody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!data || !data.length) {
            thead.innerHTML = '<tr><th>#</th></tr>';
            tbody.innerHTML = '<tr><td class="text-center text-muted py-3">No Data Loaded</td></tr>';
            return;
        }

        const baseHeaders = ['Service', 'Country', 'Weight', 'SERVICE CODE', 'Transit Time', 'Cước chính', 'Phí đăng ký'];
        const allHeaders = Object.keys(data[0]);

        // Ensure base headers come first, then others
        const headerSet = new Set(baseHeaders);
        const otherHeaders = allHeaders.filter(h => !headerSet.has(h));
        const finalHeaders = [...baseHeaders.filter(h => allHeaders.includes(h)), ...otherHeaders];

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>#</th>';
        finalHeaders.forEach(h => {
            const th = document.createElement('th');

            // ✅ NEW: Add delete button for user-added columns (from formula)
            if (userAddedColumns.has(h)) {
                th.innerHTML = `
                    <span class="d-flex align-items-center justify-content-between gap-1">
                        <span>${h}</span>
                        <button class="btn btn-sm btn-link text-danger p-0 ms-1" 
                                onclick="deleteColumn('${h}')" 
                                title="Delete this column">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </span>
                `;
                th.classList.add('bg-info-subtle'); // Highlight user-added columns
            } else {
                th.textContent = h;
                if (h === 'Cước chính' || h === 'Phí đăng ký') th.classList.add('bg-warning-subtle');
            }

            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-row-index', index);
            let rowHtml = `<td class="text-muted small">${index + 1}</td>`;

            // ✅ Kiểm tra mode VN-WW để format VND
            const isVNMode = currentMode.toLowerCase().includes('vn');

            finalHeaders.forEach((h, colIndex) => {
                const isEditable = userAddedColumns.has(h);
                let cellValue = row[h] ?? '';

                // ✅ Format VND cho các cột tiền tệ khi ở mode VN-WW
                if (isVNMode && isMoneyColumn(h) && cellValue !== '' && !isNaN(parseFloat(String(cellValue).replace(/[,.]/g, '')))) {
                    cellValue = formatVND(cellValue);
                }

                rowHtml += `<td 
                ${isEditable ? 'contenteditable="true" class="editable-cell"' : ''}
                data-col-index="${colIndex}" 
                data-col-name="${h}"
                data-raw-value="${row[h] ?? ''}"
            >${cellValue}</td>`;
            });
            tr.innerHTML = rowHtml;
            tbody.appendChild(tr);
        });
    }

    /* ================= EVENT LISTENERS ================= */

    document.addEventListener('DOMContentLoaded', function () {
        formulaModalObj = new bootstrap.Modal(document.getElementById('formulaModal'));
        joinModalObj = new bootstrap.Modal(document.getElementById('joinModal'));

        const uploadDataForm = document.getElementById('uploadDataForm');
        const dataFile = document.getElementById('dataFile');
        const dataStatus = document.getElementById('data-status');
        const step2 = document.getElementById('step-2-price');
        const step3 = document.getElementById('step-3-result');
        const btnCalculate = document.getElementById('btnCalculate');
        const btnSaveHistory = document.getElementById('btnSaveHistory');
        const btnExport = document.getElementById('btnExport');
        const btnOpenFormulaModal = document.getElementById('btnOpenFormulaModal');

        // Handle Upload Data
        uploadDataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!dataFile.files.length) return;
            dataStatus.innerText = 'Uploading...';
            const formData = new FormData();
            formData.append('file', dataFile.files[0]);
            try {
                const res = await fetch("{{ url_for('upload_data') }}", { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    currentData = json.data;
                    renderTable(currentData);
                    dataStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Imported ${currentData.length} rows.</span>`;
                    step2.classList.remove('d-none');
                    step3.classList.remove('d-none');
                    btnOpenFormulaModal.disabled = false;
                } else { dataStatus.innerText = `Error: ${json.message}`; }
            } catch (err) { dataStatus.innerText = 'Upload failed.'; }
        });

        // Handle Upload Price Table
        const uploadPriceForm = document.getElementById('uploadPriceForm');
        const priceResult = document.getElementById('priceResult');
        uploadPriceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pFile = document.getElementById('priceFile');
            if (!pFile.files.length) return;
            priceResult.innerText = 'Uploading price table...';
            const formData = new FormData();
            formData.append('file', pFile.files[0]);
            try {
                const res = await fetch("{{ url_for('upload_price_table') }}", { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    priceResult.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Price table ready.</span>`;
                    btnCalculate.disabled = false;
                } else { priceResult.innerHTML = `<span class="text-danger">Error: ${json.message}</span>`; }
            } catch (err) { priceResult.innerText = 'Price upload failed.'; }
        });

        // Handle Calculation
        btnCalculate.addEventListener('click', async () => {
            btnCalculate.disabled = true;
            btnCalculate.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculating...';
            try {
                const res = await fetch("{{ url_for('pricing_calculate_all') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData, mode: currentMode })
                });
                const json = await res.json();
                if (json.status === 'success') {
                    currentData = json.data;
                    renderTable(currentData);
                    btnSaveHistory.classList.remove('d-none');
                    btnExport.classList.remove('d-none');
                    alert('Calculation complete!');
                } else { alert(json.message); }
            } catch (err) { alert('Calculation error.'); }
            finally {
                btnCalculate.disabled = false;
                btnCalculate.innerHTML = '<i class="bi bi-calculator-fill me-1"></i> Calculate';
            }
        });

        // Handle Save History
        btnSaveHistory.addEventListener('click', async () => {
            const recordName = prompt("Enter a name for this history record:", currentMode);
            if (!recordName) {
                return; // User cancelled
            }

            btnSaveHistory.disabled = true;
            try {
                const res = await fetch('/tools/pricing/history/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData, mode: currentMode, name: recordName })
                });
                const json = await res.json();
                if (json.status === 'success') {
                    alert('History saved!');
                    if (!document.getElementById('history-panel').classList.contains('d-none')) loadHistory();
                    btnSaveHistory.classList.add('d-none');
                }
            } catch (e) { alert('Save failed.'); }
            finally { btnSaveHistory.disabled = false; }
        });

        // Handle Export
        btnExport.addEventListener('click', async () => {
            try {
                const res = await fetch("{{ url_for('export_pricing_results') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: currentData })
                });
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Pricing_Results_${new Date().getTime()}.csv`;
                a.click();
            } catch (e) { alert('Export failed.'); }
        });

        // --- FORMULA BUILDER LOGIC ---
        const formulaInput = document.getElementById('formulaInput');
        const formulaColumnsContainer = document.getElementById('formula-columns');

        const lookupHistorySelect = document.getElementById('lookupHistorySelect');
        const lookupHistoryValue = document.getElementById('lookupHistoryValue');


        btnOpenFormulaModal.addEventListener('click', () => {
            formulaColumnsContainer.innerHTML = '';
            if (!currentData.length) return;
            Object.keys(currentData[0] || {}).forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-primary';
                btn.textContent = h;
                btn.onclick = () => {
                    formulaInput.focus();
                    const text = `[${h}] `;
                    document.execCommand('insertText', false, text);
                };
                formulaColumnsContainer.appendChild(btn);
            });
            loadSavedFormulas();
            populateLookupHistory();
            formulaModalObj.show();
        });

        document.getElementById('formula-operators').addEventListener('click', (e) => {
            if (e.target.dataset.value) {
                formulaInput.focus();
                document.execCommand('insertText', false, e.target.dataset.value + ' ');
            }
        });

        // Helper function to save formula
        async function saveFormula(name, formula) {
            if (!name || !formula) return;
            try {
                const res = await fetch('/tools/pricing/formulas/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, formula })
                });
                const json = await res.json();
                if (json.status === 'success') {
                    alert(`Formula "${name}" saved!`);
                    loadSavedFormulas(); // Refresh the list
                } else { alert(json.message); }
            } catch (e) { alert('Error connecting to server.'); }
        }

        document.getElementById('applyFormula').onclick = () => {
            const colName = document.getElementById('newColumnName').value.trim();
            const originalFormulaStr = formulaInput.innerText.trim();
            let formulaStr = originalFormulaStr;
            if (!colName || !formulaStr) { alert("Please enter column name and formula."); return; }

            // --- NEW LOOKUP LOGIC ---
            let lookupMap = null;
            let isPureLookup = false; // ✅ Flag to detect pure lookup (no math operations)

            if (formulaStr.includes('lookup(') && lookupData) {
                const keyCol = lookupHistoryKey.value;
                const valCol = lookupHistoryValue.value;
                if (!keyCol || !valCol) {
                    alert('Please select the Key and Value columns for the lookup table.');
                    return;
                }
                lookupMap = new Map(lookupData.map(r => [String(r[keyCol]), r[valCol]]));

                // ✅ Check if formula is PURE lookup (no arithmetic operations)
                // Pattern: "lookup([SomeColumn])" with no other operations like +, -, *, /
                const pureLookupPattern = /^lookup\(\[.*?\]\)\s*$/;
                isPureLookup = pureLookupPattern.test(formulaStr.trim());

                // ✅ For pure lookup, use raw value; for formulas with operations, use safeNum
                if (isPureLookup) {
                    // Direct lookup - return raw value (string, number, whatever)
                    formulaStr = formulaStr.replace(/lookup\(\[(.*?)\]\)/g, (m, p1) => `lookupMap.get(String(row['${p1}']))`);
                } else {
                    // Formula with operations - convert to number
                    formulaStr = formulaStr.replace(/lookup\(\[(.*?)\]\)/g, (m, p1) => `safeNum(lookupMap.get(String(row['${p1}'])))`);
                }
            }
            // ✅ UPDATED: safeNum to handle VND format (dot as thousand separator)
            const isVNModeFormula = currentMode.toLowerCase().includes('vn');
            const safeNum = (v) => {
                if (v === null || v === undefined) return 0;
                let str = v.toString().trim();

                // ✅ VN mode: dot is thousand separator (278.752 = 278752)
                // Check if it's VN format: has dots but no commas, or has multiple dots
                if (isVNModeFormula) {
                    // If string has dots but no decimal comma, treat dots as thousand separators
                    // 278.752 -> 278752 (VND)  
                    // But 0.5 should remain 0.5 (actual decimal)
                    const dotCount = (str.match(/\./g) || []).length;
                    if (dotCount >= 1 && !str.includes(',')) {
                        // Check if it looks like VND (number with dots as separators)
                        // e.g., "278.752" or "1.234.567" - likely VND
                        // e.g., "0.5" or "1.25" - likely decimal
                        const parts = str.split('.');
                        // If all parts after first are 3 digits, it's VND format
                        const isVNDFormat = parts.slice(1).every(p => p.length === 3);
                        if (isVNDFormat && parts.length > 1) {
                            str = str.replace(/\./g, ''); // Remove all dots
                        }
                    }
                }

                // Standard handling: remove commas
                const n = parseFloat(str.replace(/,/g, ''));
                return isNaN(n) ? 0 : n;
            };

            // ✅ For pure lookup, don't wrap columns in safeNum
            let jsExpr;
            if (isPureLookup) {
                jsExpr = formulaStr; // Already has lookupMap.get()
            } else {
                jsExpr = formulaStr.replace(/\[(.*?)\]/g, (m, p1) => `safeNum(row['${p1.trim()}'])`);
            }

            try {
                const func = new Function('row', 'safeNum', 'lookupMap', `return ${jsExpr}`);
                const isVNMode = currentMode.toLowerCase().includes('vn'); // ✅ Check VN mode for rounding
                currentData.forEach(row => {
                    try {
                        const res = func(row, safeNum, lookupMap);
                        // ✅ For pure lookup, keep raw value; for formulas, format as number
                        if (isPureLookup) {
                            row[colName] = res ?? '';
                        } else if (typeof res === 'number' && !isNaN(res)) {
                            // ✅ VN-WW mode: round to whole number (no decimals)
                            // Other modes: keep 2 decimal places
                            row[colName] = isVNMode ? Math.round(res) : res.toFixed(2);
                        } else {
                            row[colName] = res ?? '';
                        }
                    } catch (e) { row[colName] = "Error"; }
                });
                userAddedColumns.add(colName);
                renderTable(currentData);
                formulaModalObj.hide();

                // Prompt to save
                if (confirm(`Formula applied successfully for column "${colName}".\n\nDo you want to save this formula for future use?`)) {
                    // Use the original formula string before it was modified for JS execution
                    saveFormula(colName, originalFormulaStr);
                }

            } catch (e) {
                console.error("Formula evaluation error:", e);
                alert('Invalid formula. Please check and try again.');
            }
        };

        // Add Blank Column
        document.getElementById('addBlankColumnBtn').addEventListener('click', () => {
            const colName = document.getElementById('blankColumnName').value.trim();
            if (!colName) { alert('Please enter a column name.'); return; }
            if (currentData.length > 0 && Object.keys(currentData[0]).includes(colName)) {
                alert(`Column "${colName}" already exists.`); return;
            }
            currentData.forEach(row => row[colName] = '');
            userAddedColumns.add(colName);
            renderTable(currentData);
            formulaModalObj.hide();
            document.getElementById('blankColumnName').value = '';
        });

        // ✅ NEW: When lookup tab is shown, populate current table columns
        document.getElementById('lookup-tab').addEventListener('shown.bs.tab', () => {
            const lookupCurrentKey = document.getElementById('lookupCurrentKey');
            const lookupMatchStatus = document.getElementById('lookupMatchStatus');
            if (lookupCurrentKey && currentData.length > 0) {
                const currentCols = Object.keys(currentData[0]);
                lookupCurrentKey.innerHTML = '<option value="">-- Select column from current table --</option>' +
                    currentCols.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            if (lookupMatchStatus) lookupMatchStatus.innerHTML = '';
        });

        // ✅ NEW: When user selects column in Step 3, check if it exists in history
        document.getElementById('lookupCurrentKey').addEventListener('change', (e) => {
            const selectedCol = e.target.value;
            const statusDiv = document.getElementById('lookupMatchStatus');

            if (!selectedCol) {
                statusDiv.innerHTML = '';
                return;
            }

            if (!lookupData || lookupData.length === 0) {
                statusDiv.innerHTML = '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i>Please select history table first (Step 2)</span>';
                return;
            }

            const historyCols = Object.keys(lookupData[0]);
            if (historyCols.includes(selectedCol)) {
                statusDiv.innerHTML = `<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Found! Column "${selectedCol}" exists in history table</span>`;
            } else {
                statusDiv.innerHTML = `<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Not Found! Column "${selectedCol}" does not exist in history table</span>`;
            }
        });

        // When a history table is selected for lookup (uses variables from line 765-767)
        lookupHistorySelect.addEventListener('change', async (e) => {
            const historyId = e.target.value;
            lookupData = null;
            lookupHistoryValue.innerHTML = '<option value="">-- Select column to get value --</option>';
            document.getElementById('lookupMatchStatus').innerHTML = '';

            if (!historyId) return;

            try {
                const res = await fetch('/tools/pricing/history/' + historyId);
                const json = await res.json();
                if (json.status === 'success' && json.item && json.item.data.length > 0) {
                    lookupData = json.item.data;
                    const historyCols = Object.keys(lookupData[0]);
                    const optionsHtml = historyCols.map(c => `<option value="${c}">${c}</option>`).join('');
                    lookupHistoryValue.innerHTML = '<option value="">-- Select column to get value --</option>' + optionsHtml;

                    // Re-check current column match if already selected
                    const currentKeyCol = document.getElementById('lookupCurrentKey').value;
                    if (currentKeyCol) {
                        document.getElementById('lookupCurrentKey').dispatchEvent(new Event('change'));
                    }
                } else {
                    alert('Could not load history table data.');
                }
            } catch (err) {
                alert('Network error loading history table.');
            }
        });

        // ✅ UPDATED: Apply Lookup Button Handler (auto-match by column name)
        document.getElementById('applyLookupBtn').addEventListener('click', () => {
            const colName = document.getElementById('lookupNewColumnName').value.trim();
            const currentKeyCol = document.getElementById('lookupCurrentKey').value;
            const historyValueCol = lookupHistoryValue.value;

            // Validation
            if (!colName) { alert('Please enter new column name (Step 1).'); return; }
            if (!lookupData) { alert('Please select history table (Step 2).'); return; }
            if (!currentKeyCol) { alert('Please select match column (Step 3).'); return; }
            if (!historyValueCol) { alert('Please select value column (Step 4).'); return; }

            // Auto-match: use same column name for history key
            const historyKeyCol = currentKeyCol;
            const historyCols = Object.keys(lookupData[0]);
            if (!historyCols.includes(historyKeyCol)) {
                alert(`Column "${historyKeyCol}" does not exist in history table! Cannot auto-match.`);
                return;
            }

            // Check if column already exists
            if (currentData.length > 0 && Object.keys(currentData[0]).includes(colName)) {
                alert(`Column "${colName}" already exists!`);
                return;
            }

            // Build lookup map: historyKeyCol -> historyValueCol
            const lookupMap = new Map(lookupData.map(r => [String(r[historyKeyCol]), r[historyValueCol]]));

            // Apply lookup to each row
            let matchCount = 0;
            currentData.forEach(row => {
                const keyValue = String(row[currentKeyCol] ?? '');
                if (lookupMap.has(keyValue)) {
                    row[colName] = lookupMap.get(keyValue);
                    matchCount++;
                } else {
                    row[colName] = ''; // No match
                }
            });

            userAddedColumns.add(colName);
            renderTable(currentData);
            formulaModalObj.hide();

            // Reset form
            document.getElementById('lookupNewColumnName').value = '';

            alert(`Lookup complete! Matched ${matchCount}/${currentData.length} rows.`);
        });
    });

    async function loadSavedFormulas() {
        const container = document.getElementById('saved-formulas-container');
        if (!container) return;
        container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        try {
            const res = await fetch('/tools/pricing/formulas');
            const json = await res.json();
            if (json.status === 'success') {
                if (json.formulas.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-3">No saved formulas found.</div>';
                    return;
                }
                container.innerHTML = '';
                json.formulas.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'd-flex justify-content-between align-items-center p-2 border-bottom';

                    const nameDiv = document.createElement('div');
                    nameDiv.innerHTML = `<div class="fw-bold"></div><code class="small text-muted"></code>`;
                    nameDiv.querySelector('.fw-bold').textContent = f.name;
                    nameDiv.querySelector('code').textContent = f.formula;

                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'btn-group';

                    const applyBtn = document.createElement('button');
                    applyBtn.className = 'btn btn-sm btn-outline-primary';
                    applyBtn.textContent = 'Apply';
                    applyBtn.dataset.formulaName = f.name;
                    applyBtn.dataset.formulaStr = f.formula;
                    applyBtn.onclick = function () {
                        applySavedFormulaAsNewColumn(this.dataset.formulaName, this.dataset.formulaStr);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.onclick = () => deleteSavedFormula(f._id);

                    btnGroup.appendChild(applyBtn);
                    btnGroup.appendChild(deleteBtn);
                    div.appendChild(nameDiv);
                    div.appendChild(btnGroup);
                    container.appendChild(div);
                });
            }
        } catch (e) { container.innerHTML = '<span class="text-danger small">Error loading data.</span>'; }
    }

    async function populateLookupHistory() {
        const lookupHistorySelect = document.getElementById('lookupHistorySelect');
        lookupHistorySelect.innerHTML = '<option>Loading...</option>';
        try {
            const res = await fetch('/tools/pricing/history');
            const json = await res.json();
            if (json.status === 'success' && json.items) {
                lookupHistorySelect.innerHTML = '<option value="">-- Select a history table --</option>';
                json.items.forEach(h => {
                    lookupHistorySelect.innerHTML += `<option value="${h._id}">${h.name || h.mode}</option>`;
                });
            }
        } catch (e) {
            lookupHistorySelect.innerHTML = '<option>Error loading</option>';
        }
    }

    async function applySavedFormulaAsNewColumn(name, formulaStr) {
        const colName = prompt("Enter a name for the new column:", name);
        if (!colName) return;

        // This is a simplified version of the main applyFormula logic
        const safeNum = (v) => {
            if (v === null || v === undefined) return 0;
            const n = parseFloat(v.toString().replace(/,/g, ''));
            return isNaN(n) ? 0 : n;
        };

        // Note: This simplified version does not support lookup from a saved formula.
        const jsExpr = formulaStr.replace(/\[(.*?)\]/g, (m, p1) => `safeNum(row['${p1.trim()}'])`);
        try {
            const func = new Function('row', 'safeNum', `return ${jsExpr}`);
            currentData.forEach(row => {
                try {
                    const res = func(row, safeNum);
                    row[colName] = (typeof res === 'number' && !isNaN(res)) ? res.toFixed(2) : (res ?? '');
                } catch (e) { row[colName] = "Error"; }
            });
            userAddedColumns.add(colName);
            renderTable(currentData);
            formulaModalObj.hide();
            alert(`Applied saved formula "${name}" to new column "${colName}".`);
        } catch (e) {
            console.error("Saved formula evaluation error:", e);
            alert('The saved formula is invalid. Please check it.');
        }
    }



    async function deleteSavedFormula(id) {
        if (!confirm('Delete this saved formula?')) return;
        try {
            const res = await fetch('/tools/pricing/formulas/delete/' + id, { method: 'POST' });
            const json = await res.json();
            if (json.status === 'success') {
                loadSavedFormulas();
            }
        } catch (e) { alert("Cannot delete formula."); }
    }

    async function loadForComparison(id) {
        try {
            const res = await fetch('/tools/pricing/history/' + id);
            const json = await res.json();
            if (json.status === 'success') {
                comparisonData = json.item.data;
                const selCurrent = document.getElementById('joinKeyCurrent');
                const selHistory = document.getElementById('joinKeyHistory');
                const cols = Object.keys(currentData[0] || {});
                const hCols = Object.keys(comparisonData[0] || {});
                selCurrent.innerHTML = cols.map(c => `<option value="${c}">${c}</option>`).join('');
                selHistory.innerHTML = hCols.map(c => `<option value="${c}">${c}</option>`).join('');
                joinModalObj.show();
            }
        } catch (e) { alert("Error loading comparison data."); }
    }

    document.getElementById('applyJoin').onclick = () => {
        const keyC = document.getElementById('joinKeyCurrent').value;
        const keyH = document.getElementById('joinKeyHistory').value;
        const prefix = document.getElementById('historyPrefix').value;
        if (!keyC || !keyH) return;
        const hMap = new Map(comparisonData.map(r => [r[keyH], r]));
        currentData.forEach(row => {
            const hRow = hMap.get(row[keyC]);
            if (hRow) Object.keys(hRow).forEach(k => { row[prefix + k] = hRow[k]; });
        });
        renderTable(currentData);
        joinModalObj.hide();
    };

    /* ================= DRAG-TO-FILL LOGIC ================= */
    const tableBody = document.getElementById('dataTableBody');
    let isDragging = false;
    let startCell = null;
    let endCell = null;

    tableBody.addEventListener('mousedown', (e) => {
        const target = e.target;
        if (target.classList.contains('editable-cell')) {
            const rect = target.getBoundingClientRect();
            // Check if click is on the bottom-right corner (the "handle")
            if (e.clientX > rect.right - 10 && e.clientY > rect.bottom - 10) {
                isDragging = true;
                startCell = target;
                e.preventDefault(); // Prevent text selection
                document.body.style.cursor = 'crosshair';
            }
        }
    });

    tableBody.addEventListener('mouseover', (e) => {
        if (!isDragging || !startCell) return;
        const target = e.target;
        if (target.tagName === 'TD' && target.dataset.colName === startCell.dataset.colName) {
            endCell = target;
            // Clear previous selections
            tableBody.querySelectorAll('.fill-selection').forEach(c => c.classList.remove('fill-selection'));
            // Highlight cells between start and end
            const startRow = parseInt(startCell.parentElement.dataset.rowIndex);
            const endRow = parseInt(endCell.parentElement.dataset.rowIndex);
            const colIndex = startCell.dataset.colIndex;

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);

            for (let i = minRow; i <= maxRow; i++) {
                const cell = tableBody.querySelector(`tr[data-row-index='${i}'] td[data-col-index='${colIndex}']`);
                if (cell) cell.classList.add('fill-selection');
            }
        }
    });

    document.addEventListener('mouseup', (e) => {
        if (!isDragging || !startCell) {
            isDragging = false;
            return;
        }

        isDragging = false;
        document.body.style.cursor = 'default';

        const selectedCells = tableBody.querySelectorAll('.fill-selection');
        if (selectedCells.length > 0) {
            const valueToCopy = startCell.innerText;
            const colName = startCell.dataset.colName;

            selectedCells.forEach(cell => {
                if (cell !== startCell) {
                    cell.innerText = valueToCopy;
                    const rowIndex = parseInt(cell.parentElement.dataset.rowIndex);
                    if (currentData[rowIndex]) {
                        currentData[rowIndex][colName] = valueToCopy;
                    }
                }
            });
        }

        // Clean up
        tableBody.querySelectorAll('.fill-selection').forEach(c => c.classList.remove('fill-selection'));
        startCell = null;
        endCell = null;
    });

    // Update data array when a cell is edited manually
    tableBody.addEventListener('blur', (e) => {
        const target = e.target;
        if (target.classList.contains('editable-cell')) {
            const rowIndex = parseInt(target.parentElement.dataset.rowIndex);
            const colName = target.dataset.colName;
            if (currentData[rowIndex] && currentData[rowIndex][colName] !== target.innerText) {
                currentData[rowIndex][colName] = target.innerText;
            }
        }
    }, true); // Use capture phase to catch blur event
</script>
{% endblock %}