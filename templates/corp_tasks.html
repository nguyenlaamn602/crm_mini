{% extends "base.html" %}
{% block title %}Company Tasks - THG{% endblock %}

{% block content %}

{# Status color mapping #}
{% set status_color = {
  "Unreceived": "bg-danger",
  "Received": "bg-brown",
  "In_progress": "bg-warning text-dark",
  "Pending_approval": "bg-primary",
  "Done": "bg-success",
  "Cancelled": "bg-light text-dark border"
} %}

<div class="container-fluid p-0">
  <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-4 rounded-4 shadow-sm">
    <div>
      <h4 class="mb-1 fw-bold text-dark">Company Tasks</h4>

      {% if current_user.role == 'admin' %}
      <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm mt-3"
              data-bs-toggle="modal" data-bs-target="#addCorpTaskModal">
        <i class="bi bi-plus-lg me-1"></i> Create New Task
      </button>
      {% endif %}
    </div>

    <form action="/corp-tasks" method="GET" class="d-flex gap-3">
      <input type="hidden" name="dept" value="{{ request.args.get('dept','') }}">

      <div class="input-group input-group-sm bg-light rounded-pill px-3 py-1 border-0" style="width: 320px;">
        <span class="input-group-text border-0 bg-transparent text-muted">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" name="search" class="form-control border-0 bg-transparent"
               placeholder="Search content / assignee..."
               value="{{ request.args.get('search', '') }}">
      </div>

      <select name="status"
              class="form-select form-select-sm bg-light border-0 rounded-pill px-4"
              onchange="this.form.submit()" style="width: 190px;">
        <option value="">-- All Statuses --</option>
        {% for st in corp_statuses %}
          <option value="{{ st }}" {% if request.args.get('status') == st %}selected{% endif %}>
            {{ corp_status_labels.get(st, st) }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- Department tabs -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    {% set current_dept = request.args.get('dept','') %}
    <a href="/corp-tasks"
       class="btn btn-sm rounded-pill {% if not current_dept %}btn-primary{% else %}btn-outline-primary{% endif %}">
      All
    </a>
    {% for d in corp_departments %}
      <a href="/corp-tasks?dept={{ d }}
        {% if request.args.get('status') %}&status={{ request.args.get('status') }}{% endif %}
        {% if request.args.get('search') %}&search={{ request.args.get('search') }}{% endif %}"
         class="btn btn-sm rounded-pill {% if current_dept == d %}btn-primary{% else %}btn-outline-primary{% endif %}">
        {{ d }}
      </a>
    {% endfor %}
  </div>

  <!-- ====================== CHART (NEW) ====================== -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0">Company Task Overview</h6>

      </div>

      <div class="row text-center mb-3">
        <div class="col">
          <div class="fw-bold fs-5" id="statTotal">0</div>
          <div class="text-muted small">Total</div>
        </div>
        <div class="col">
          <div class="fw-bold fs-5 text-success" id="statDone">0</div>
          <div class="text-muted small">Done</div>
        </div>
        <div class="col">
          <div class="fw-bold fs-5 text-warning" id="statNotDone">0</div>
          <div class="text-muted small">Not Done</div>
        </div>
      </div>
<div style="width:300px; height:300px; margin: 0 auto;">
  <canvas id="corpTaskChart"></canvas>
</div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table align-middle mb-0 table-hover bg-white">
        <thead class="bg-light text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.05rem;">
          <tr>
            <th class="ps-4 py-3 text-muted" style="width: 60px;">NO.</th>
            <th class="text-muted" style="max-width: 420px;">TASK</th>
            <th class="text-muted">DEPARTMENT</th>
            <th class="text-muted">DEADLINE</th>
            <th class="text-muted">ASSIGNEE</th>
            <th class="text-center text-muted">STATUS</th>
            <th class="pe-4 text-end text-muted">ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          {% for t in corp_tasks %}
          <tr>
            <td class="ps-4"><span class="text-muted fw-bold">{{ loop.index }}</span></td>

            <td style="max-width: 420px;">
              <div class="d-flex flex-column">
                <span class="fw-bold text-dark" style="font-size: 0.95rem; line-height: 1.3;">
                  {{ t.title }}
                </span>
                <span class="text-muted small mt-1">
                  <i class="bi bi-person-check me-1"></i>Assigned by: {{ t.assigned_by or '---' }}
                  {% if t.assigned_at %} â€¢ {{ t.assigned_at.strftime('%d/%m %H:%M') }}{% endif %}
                </span>
              </div>
            </td>

            <td>
              <span class="badge bg-secondary-subtle text-secondary border rounded-pill px-3 py-2">
                {{ t.department }}
              </span>
            </td>

            <td class="small text-secondary fw-medium">
              {% if t.due_at %}
                <i class="bi bi-calendar2-event me-1"></i>{{ t.due_at.strftime('%H:%M %d/%m') }}
              {% else %}
                ---
              {% endif %}
            </td>

            <td>
              <div class="d-flex align-items-center">
                {# Avatar = first letter of first assignee (keeps old style) #}
                <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2"
                     style="width: 28px; height: 28px; font-size: 0.8rem; font-weight: bold;">
                  {{ (t.assignees[0][0].upper()) if t.assignees and t.assignees[0] else (t.assignee[0].upper() if t.assignee else '?') }}
                </div>

                {# Multi assignees badges (new) #}
                <div class="d-flex flex-wrap gap-1">
                  {% for name in (t.assignees if t.assignees else [t.assignee]) %}
                    {% if name %}
                      <span class="badge bg-primary-subtle text-primary border rounded-pill px-2 py-1">
                        {{ name }}
                      </span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </td>

            <td class="text-center">
              {# Multi-assignee permission: admin OR user is in assigned_to list #}
              {% set assigned_ids = t.assigned_to | map('string') | list %}
              {% set can_change = (current_user.role == 'admin') or ((current_user.id|string) in assigned_ids) %}

              {% if can_change %}
                <div class="dropdown">
                  <button class="btn btn-sm rounded-pill px-3 dropdown-toggle {{ status_color.get(t.status,'btn-light') }}"
                          data-bs-toggle="dropdown">
                    {{ corp_status_labels.get(t.status, t.status) }}
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end border-0 shadow rounded-3 p-2">
                    {% for st in corp_statuses %}
                      <li>
                        <button class="dropdown-item rounded-2" onclick="updateCorpStatus('{{ t.id }}','{{ st }}')">
                          {{ corp_status_labels.get(st, st) }}
                        </button>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <span class="badge rounded-pill px-3 py-2 {{ status_color.get(t.status,'bg-light text-dark border') }}">
                  {{ corp_status_labels.get(t.status, t.status) }}
                </span>
              {% endif %}
            </td>

            <td class="pe-4 text-end">
              <div class="dropdown">
                <button class="btn btn-link text-muted p-0 shadow-none" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots-vertical fs-5"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow rounded-3 p-2">
                  {% if current_user.role == 'admin' %}
                  <li>
                    <button class="dropdown-item rounded-2" data-bs-toggle="modal" data-bs-target="#editCorpTask{{ t.id }}">
                      <i class="bi bi-pencil me-2"></i>Edit
                    </button>
                  </li>

                  <li><hr class="dropdown-divider"></li>

                  <li>
                    <form method="POST" action="/corp-task/delete/{{ t.id }}" onsubmit="return confirm('Delete this task?');">
                      <button type="submit" class="dropdown-item text-danger rounded-2">
                        <i class="bi bi-trash me-2"></i>Delete Task
                      </button>
                    </form>
                  </li>

                  {% else %}
                    {# Non-admin: keep menu, but no delete. Show cancel only if can_change #}
                    {% if can_change %}
                      <li>
                        <button class="dropdown-item text-danger rounded-2" onclick="updateCorpStatus('{{ t.id }}','Cancelled')">
                          <i class="bi bi-x-circle me-2"></i>Cancel Task
                        </button>
                      </li>
                    {% else %}
                      <li>
                        <span class="dropdown-item text-muted rounded-2">
                          <i class="bi bi-shield-lock me-2"></i>No permission
                        </span>
                      </li>
                    {% endif %}
                  {% endif %}
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}

          {% if not corp_tasks %}
          <tr>
            <td colspan="7" class="text-center py-5 text-muted">
              <i class="bi bi-inbox fs-2 d-block mb-2"></i> No tasks found.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if current_user.role == 'admin' %}
<!-- Create corp task -->
<div class="modal fade" id="addCorpTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="modal-header bg-primary text-white py-3 px-4">
        <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>Create Company Task</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form action="/corp-task/add" method="POST" id="addCorpTaskForm">
        <div class="modal-body p-4">
          <div class="mb-3">
            <label class="form-label fw-bold text-muted small">TASK CONTENT</label>
            <textarea name="title" class="form-control rounded-3" rows="3" required placeholder="What needs to be done?"></textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">DEPARTMENT</label>
              <select name="department" class="form-select rounded-3" required>
                {% for d in corp_departments %}
                  <option value="{{ d }}">{{ d }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">ASSIGNEES</label>

              <div class="border rounded-3 p-2" style="max-height:180px; overflow-y:auto;">
                {% for u in users_list %}
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="assigned_user_ids"
                         value="{{ u._id }}"
                         id="assign_{{ u._id }}">
                  <label class="form-check-label" for="assign_{{ u._id }}">
                    {{ u.username }}
                  </label>
                </div>
                {% endfor %}
              </div>

              <small class="text-muted">Select one or multiple assignees</small>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label fw-bold text-muted small">DEADLINE</label>
            <input type="datetime-local" name="due_at" class="form-control rounded-3" required>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">STATUS</label>
              <input type="text" class="form-control rounded-3 bg-light" value="Unreceived (auto)" readonly disabled>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">CREATOR</label>
              <input type="text" class="form-control rounded-3 bg-light" value="{{ current_user.username }}" readonly disabled>
            </div>
          </div>

        </div>

        <div class="modal-footer border-0 bg-light px-4 py-3">
          <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit corp task -->
{% for t in corp_tasks %}
<div class="modal fade" id="editCorpTask{{ t.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="modal-header bg-primary text-white py-3 px-4">
        <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Edit Company Task</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form action="/corp-task/update/{{ t.id }}" method="POST" class="editCorpTaskForm">
        <div class="modal-body p-4">
          <div class="mb-3">
            <label class="form-label fw-bold text-muted small">TASK CONTENT</label>
            <textarea name="title" class="form-control rounded-3" rows="3" required>{{ t.title }}</textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">DEPARTMENT</label>
              <select name="department" class="form-select rounded-3" required>
                {% for d in corp_departments %}
                  <option value="{{ d }}" {% if t.department == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold text-muted small">ASSIGNEES</label>

              {# Ensure assigned_to is treated as list (backend already normalizes) #}
              {% set edit_assigned_ids = t.assigned_to | map('string') | list %}

              <div class="border rounded-3 p-2" style="max-height:180px; overflow-y:auto;">
                {% for u in users_list %}
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="assigned_user_ids"
                         value="{{ u._id }}"
                         id="edit_assign_{{ t.id }}_{{ u._id }}"
                         {% if (u._id|string) in edit_assigned_ids %}checked{% endif %}>
                  <label class="form-check-label" for="edit_assign_{{ t.id }}_{{ u._id }}">
                    {{ u.username }}
                  </label>
                </div>
                {% endfor %}
              </div>

              <small class="text-muted">Select one or multiple assignees</small>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label fw-bold text-muted small">DEADLINE</label>
            <input type="datetime-local" name="due_at" class="form-control rounded-3"
                   value="{{ t.due_at.strftime('%Y-%m-%dT%H:%M') if t.due_at else '' }}" required>
          </div>
        </div>

        <div class="modal-footer border-0 bg-light px-4 py-3">
          <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endif %}

<script>
  async function updateCorpStatus(taskId, status) {
    try {
      const res = await fetch(`/corp-task/status/${taskId}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
        body: JSON.stringify({status})
      });
      const data = await res.json();
      if (data.status === 'success') location.reload();
      else alert(data.message || 'Unable to update status');
    } catch(e) {
      console.error(e);
      alert('Status update error');
    }
  }

  // Frontend validation for checkbox group (Create + Edit)
  (function () {
    const addForm = document.getElementById('addCorpTaskForm');
    if (addForm) {
      addForm.addEventListener('submit', function (e) {
        const checked = addForm.querySelectorAll('input[name="assigned_user_ids"]:checked');
        if (!checked || checked.length === 0) {
          e.preventDefault();
          alert('Please select at least 1 assignee.');
        }
      });
    }

    const editForms = document.querySelectorAll('.editCorpTaskForm');
    if (editForms && editForms.length) {
      editForms.forEach(function (f) {
        f.addEventListener('submit', function (e) {
          const checked = this.querySelectorAll('input[name="assigned_user_ids"]:checked');
          if (!checked || checked.length === 0) {
            e.preventDefault();
            alert('Please select at least 1 assignee.');
          }
        });
      });
    }
  })();
</script>

<style>
  .table-hover tbody tr:hover { background-color: #f8faff !important; }

  /* Brown for "Received" status */
  .bg-brown {
    background-color: #8b5e3c !important;
    color: #fff !important;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const _corpTasks = {{ corp_tasks_chart | tojson }};

  function buildCorpStats(dept) {
    let list = _corpTasks;
    if (dept !== 'ALL') {
      list = list.filter(t => t.department === dept);
    }
    const total = list.length;
    const done = list.filter(t => t.status === 'Done').length;
    const notDone = total - done;
    return { total, done, notDone };
  }

  const ctx = document.getElementById('corpTaskChart');
  if (ctx) {
    let s = buildCorpStats('ALL');

    document.getElementById('statTotal').innerText = s.total;
    document.getElementById('statDone').innerText = s.done;
    document.getElementById('statNotDone').innerText = s.notDone;

    const chart = new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Done', 'Not Done'],
        datasets: [{
          data: [s.done, s.notDone],
          backgroundColor: ['#198754', '#ffc107']
        }]
      },
      options: {
        plugins: { legend: { position: 'bottom' } }
      }
    });

  }
</script>

{% endblock %}
