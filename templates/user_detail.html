{% extends "base.html" %}
{% block title %}User Detail - {{ staff.username }}{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/admin/users" class="text-decoration-none text-secondary small fw-bold">
                <i class="bi bi-arrow-left me-1"></i> Back to Users
            </a>
            <h4 class="fw-bold mt-2 mb-0">User Profile: {{ staff.username }}</h4>
        </div>
        <div>
            {% if staff.role == 'superadmin' %}
            <span class="badge bg-dark fs-6 rounded-pill px-3">Superadmin</span>
            {% elif staff.role == 'admin' %}
            <span class="badge bg-danger fs-6 rounded-pill px-3">Admin</span>
            {% else %}
            <span class="badge bg-success fs-6 rounded-pill px-3">User</span>
            {% endif %}
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flash-messages">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} rounded-4 mb-4 shadow-sm border-0 fade show" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="row g-4">
        <!-- Left: User Info & Settings -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4 text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
                        style="width: 80px; height: 80px; font-size: 2rem; font-weight: bold;">
                        {{ staff.username[0].upper() }}
                    </div>
                    <h5 class="fw-bold mb-1">{{ staff.username }}</h5>
                    <p class="text-muted small mb-3">ID: {{ staff._id }}</p>

                    <hr class="my-4 opacity-25">

                    <!-- Role Update (ONLY SUPERADMIN) -->
                    {% if current_user.role == 'superadmin' %}
                    <form action="/admin/user/update_role/{{ staff._id }}" method="POST" class="mb-4 text-start">
                        <label class="form-label small fw-bold text-muted">Role (Superadmin Only)</label>
                        <select name="role" class="form-select rounded-3" onchange="this.form.submit()">
                            <option value="superadmin" {% if staff.role=='superadmin' %}selected{% endif %}>Superadmin
                            </option>
                            <option value="user" {% if staff.role=='user' %}selected{% endif %}>User</option>
                            <option value="admin" {% if staff.role=='admin' %}selected{% endif %}>Admin</option>
                        </select>
                    </form>
                    {% endif %}

                    <!-- Department Update (ONLY SUPERADMIN) -->
                    {% if current_user.role == 'superadmin' %}
                    <form action="/admin/user/update_departments/{{ staff._id }}" method="POST" class="mb-4 text-start"
                        id="updateDeptsForm">
                        <label class="form-label small fw-bold text-muted">Departments (Superadmin)</label>
                        <!-- ✅ Changed to Checklist for consistent UI -->
                        <div class="border rounded-3 p-3 bg-light mb-2" style="max-height: 200px; overflow-y: auto;">
                            {% for dept in departments %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="departments" value="{{ dept }}"
                                    id="upd_dept_{{ loop.index }}" {% if dept in staff.departments %}checked{% endif %}>
                                <label class="form-check-label small" for="upd_dept_{{ loop.index }}">{{ dept }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100 rounded-pill shadow-sm">Update
                            Departments</button>
                    </form>
                    {% else %}
                    <div class="mb-4 text-start">
                        <label class="form-label small fw-bold text-muted">Departments</label>
                        <div class="p-2 bg-light rounded-3 border d-flex flex-wrap gap-1">
                            {% for dept in staff.departments %}
                            <span class="badge bg-secondary border-0">{{ dept }}</span>
                            {% else %}
                            <span class="text-muted small">-- Unassigned --</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ✅ Admin/Superadmin Update Telegram ID -->
                    {% if current_user.role in ['superadmin', 'admin'] %}
                    <form action="/admin/user/update-telegram/{{ staff._id }}" method="POST" class="mb-3 text-start">
                        <label class="form-label small fw-bold text-muted">Telegram Chat ID</label>
                        <div class="input-group">
                            <input type="text" name="telegram_id" class="form-control rounded-start-3"
                                value="{{ staff.telegram_chat_id or '' }}" placeholder="Chat ID...">
                            <button class="btn btn-outline-secondary rounded-end-3" type="submit">
                                <i class="bi bi-save"></i>
                            </button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Delete User -->
            {% if current_user.role in ['superadmin', 'admin'] %}
            <div class="card border-0 shadow-sm rounded-4 bg-danger-subtle mb-4">
                <div class="card-body p-4">
                    <h6 class="fw-bold text-danger">Danger Zone</h6>
                    <p class="small text-danger opacity-75 mb-3">Deleting a user is irreversible.</p>
                    <form action="/admin/user/delete/{{ staff._id }}" method="POST"
                        onsubmit="return confirm('Permanently delete this user?');">
                        <button class="btn btn-danger w-100 rounded-pill">Delete User</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Charts -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                    <h6 class="fw-bold">Analytics</h6>
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                        <div class="small text-center text-muted mb-2">Task Distribution</div>
                        <div style="height: 200px;">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                    <hr>
                    <div class="mt-4">
                        <div class="small text-center text-muted mb-2">Completion Status</div>
                        <div style="height: 200px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Stats & Tasks -->
        <div class="col-lg-8">
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 border-start border-4 border-primary">
                        <div class="text-muted small fw-bold text-uppercase">Total Tasks</div>
                        <div class="fs-2 fw-bold text-dark mt-2">{{ stats.total }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 border-start border-4 border-success">
                        <div class="text-muted small fw-bold text-uppercase">Completed</div>
                        <div class="fs-2 fw-bold text-success mt-2">{{ stats.done }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-4 bg-white rounded-4 shadow-sm h-100 border-start border-4 border-warning">
                        <div class="text-muted small fw-bold text-uppercase">Pending</div>
                        <div class="fs-2 fw-bold text-warning mt-2">{{ stats.not_yet }}</div>
                    </div>
                </div>
            </div>

            <!-- Task Lists Tabs -->
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-bottom border-light px-4 pt-4">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active fw-bold" data-bs-toggle="tab" href="#customerTasks">Customer Tasks
                                ({{ task_breakdown.customer.total }})</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-bold" data-bs-toggle="tab" href="#corpTasks">Corp Tasks ({{
                                task_breakdown.corp.total }})</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-bold" data-bs-toggle="tab" href="#personalTasks">Personal ({{
                                task_breakdown.personal.total }})</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-bold" data-bs-toggle="tab" href="#departmentTasks">Department ({{
                                task_breakdown.department.total }})</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content">
                        <!-- Customer Tasks -->
                        <div class="tab-pane fade show active" id="customerTasks">
                            {% if tasks %}
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="bg-light small">
                                        <tr>
                                            <th class="ps-4">Content</th>
                                            <th>Status</th>
                                            <th class="pe-4 text-end">Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in tasks %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ t.todo_content }}</td>
                                            <td>
                                                <span
                                                    class="badge rounded-pill px-3 
                                                    {% if t.status == 'done' %}bg-success{% elif t.status == 'overdue' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                    {{ t.status }}
                                                </span>
                                            </td>
                                            <td class="pe-4 text-end small text-muted">{{ t.updated_at.strftime('%d/%m
                                                %H:%M') }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">No customer tasks found.</div>
                            {% endif %}
                        </div>

                        <!-- Corp Tasks -->
                        <div class="tab-pane fade" id="corpTasks">
                            {% if corp_tasks %}
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="bg-light small">
                                        <tr>
                                            <th class="ps-4">Title</th>
                                            <th>Dept</th>
                                            <th>Status</th>
                                            <th class="pe-4 text-end">Deadline</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in corp_tasks %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ t.title }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ t.department }}</span>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge rounded-pill px-3 
                                                    {% if t.status == 'done' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                                    {{ t.status }}
                                                </span>
                                            </td>
                                            <td class="pe-4 text-end small text-muted">
                                                {{ t.due_at.strftime('%d/%m') if t.due_at else '-' }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">No company tasks found.</div>
                            {% endif %}
                        </div>

                        <!-- Personal Tasks (HIDDEN DETAILS - METRICS ONLY) -->
                        <div class="tab-pane fade" id="personalTasks">
                            <div class="d-flex flex-column align-items-center justify-content-center py-5 text-center">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-3"
                                    style="width: 80px; height: 80px;">
                                    <i class="bi bi-shield-lock-fill fs-1 text-secondary opacity-50"></i>
                                </div>
                                <h5 class="fw-bold text-dark mb-1">Private Content</h5>
                                <p class="text-muted mb-4 small" style="max-width: 300px;">
                                    Personal tasks are private to the user. <br>
                                    Admin can only view the measurement metrics below.
                                </p>

                                <div class="row g-2 w-100 px-4" style="max-width: 500px;">
                                    <div class="col-4">
                                        <div class="p-3 border rounded-3 bg-white shadow-sm">
                                            <div class="small text-muted fw-bold text-uppercase mb-1"
                                                style="font-size: 0.7rem;">Total</div>
                                            <div class="fw-bold fs-4 text-dark">{{ task_breakdown.personal.total }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 border rounded-3 bg-white shadow-sm">
                                            <div class="small text-muted fw-bold text-uppercase mb-1"
                                                style="font-size: 0.7rem;">Done</div>
                                            <div class="fw-bold fs-4 text-success">{{ task_breakdown.personal.done }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-3 border rounded-3 bg-white shadow-sm">
                                            <div class="small text-muted fw-bold text-uppercase mb-1"
                                                style="font-size: 0.7rem;">Pending</div>
                                            <div class="fw-bold fs-4 text-warning">{{ task_breakdown.personal.not_yet }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Department Tasks -->
                        <div class="tab-pane fade" id="departmentTasks">
                            {% if department_tasks %}
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="bg-light small">
                                        <tr>
                                            <th class="ps-4">Title</th>
                                            <th>Dept</th>
                                            <th>Status</th>
                                            <th class="pe-4 text-end">Deadline</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in department_tasks %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ t.title }}</td>
                                            <td><span class="badge bg-light text-dark border">{{ t.department }}</span>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge rounded-pill px-3 
                                                    {% if t.status == 'done' %}bg-success{% elif t.status == 'overdue' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                                    {{ t.status }}
                                                </span>
                                            </td>
                                            <td class="pe-4 text-end small text-muted">
                                                {{ t.due_at.strftime('%d/%m') if t.due_at else '-' }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-building-fill-gear fs-2 d-block mb-2 opacity-25"></i>
                                <h5 class="fw-bold text-dark mb-1">No Department Tasks</h5>
                                <p class="text-muted small">This user has no department tasks or is not part of a
                                    department with tasks.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dataBreakdown = {{ chart_data.breakdown | tojson }};
    const dataStatus = {{ chart_data.status | tojson }};

    new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: {
            labels: ['Customer', 'Corp', 'Personal', 'Department'],
            datasets: [{
                data: dataBreakdown,
                backgroundColor: ['#0d6efd', '#6610f2', '#fd7e14', '#198754'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
        }
    });

    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: ['Done', 'Pending', 'Missed'],
            datasets: [{
                data: dataStatus,
                backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function (alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 1500);

        const updateDeptsForm = document.getElementById('updateDeptsForm');
        if (updateDeptsForm) {
            updateDeptsForm.addEventListener('submit', function (e) {
                const checkboxes = this.querySelectorAll('input[name="departments"]:checked');
                if (checkboxes.length === 0) {
                    e.preventDefault();
                    alert('Please select at least one department.');
                }
            });
        }
    });
</script>
{% endblock %}