{% extends "base.html" %}
{% block title %}Pancake Broadcast{% endblock %}

{% block content %}
<div class="container-fluid p-0">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">
            <i class="bi bi-megaphone-fill me-2 text-primary"></i>
            Pancake Broadcast
        </h3>
    </div>

    <div class="row g-4">

        <!-- LEFT: LEAD PICKER -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm rounded-4 h-100">

                <div class="card-header bg-white border-0 pt-4 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0">Select Customers</h6>

                        <div class="d-flex gap-2 align-items-center">
                            <select id="sectorFilter" class="form-select form-select-sm rounded-pill">
                                <option value="">All sectors</option>
                                {% for s in sectors %}
                                <option value="{{ s }}">{{ s.replace('_',' ') }}</option>
                                {% endfor %}
                            </select>

                            <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="loadLeads()">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ✅ NEW: SEARCH INPUT -->
                    <div class="mt-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0 rounded-start-pill">
                                <i class="bi bi-search"></i>
                            </span>
                            <input id="nameSearch" type="text" class="form-control bg-light border-0 rounded-end-pill"
                                   placeholder="Search by name..." oninput="renderLeads()">
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light small text-muted">
                                <tr>
                                    <th class="ps-4" style="width:40px;">
                                        <input type="checkbox" id="checkAll" onchange="toggleAll(this)">
                                    </th>
                                    <th>Name</th>
                                    <th>Page</th>
                                </tr>
                            </thead>
                            <tbody id="leadTable">
                                <tr>
                                    <td colspan="3" class="text-center py-5 text-muted">
                                        <i class="bi bi-arrow-repeat fs-4 d-block mb-2"></i>
                                        Load customers to start
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- RIGHT: MESSAGE COMPOSER -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h6 class="fw-bold mb-0">Compose Message</h6>
                </div>

                <div class="card-body px-4">

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">SEND MODE</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sendMode" value="selected" checked>
                                <label class="form-check-label">Send selected</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sendMode" value="all">
                                <label class="form-check-label">Send ALL</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">MESSAGE CONTENT</label>
                        <textarea id="messageContent" class="form-control rounded-3" rows="7"
                                  placeholder="Type your broadcast message here..."></textarea>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small fw-bold text-muted">IMAGES (OPTIONAL)</label>
                        <input type="file" id="imageInput" class="form-control" multiple accept="image/*">
                        <div id="imagePreview" class="d-flex gap-2 mt-2 flex-wrap"></div>
                    </div>

                    <!-- ✅ MOVE SEND BUTTON: ngay dưới chọn tệp -->
                    <div class="mt-3">
                        <button class="btn btn-primary w-100 rounded-pill fw-bold" onclick="sendBroadcast()">
                            <i class="bi bi-send-fill me-2"></i>Send Broadcast
                        </button>
                    </div>

                    <div class="text-muted small mt-2">
                        Tip: Use “Search by name” to quickly pick customers.
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- RESULT MODAL -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Broadcast Result</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul id="resultList" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>
</div>

<script>
let leads = [];
let filteredLeads = [];

/* LOAD LEADS */
async function loadLeads() {
    const sector = document.getElementById('sectorFilter').value;
    const res = await fetch(`/api/pancake/broadcast/leads?sector=${encodeURIComponent(sector)}`);
    const data = await res.json();
    leads = data.leads || [];

    // reset search + checkAll
    document.getElementById('nameSearch').value = '';
    document.getElementById('checkAll').checked = false;

    renderLeads();
}

/* ✅ NEW: render with name filter */
function renderLeads() {
    const kw = (document.getElementById('nameSearch').value || '').trim().toLowerCase();

    filteredLeads = leads.filter(l => {
        const name = (l.full_name || '').toLowerCase();
        return !kw || name.includes(kw);
    });

    const tbody = document.getElementById('leadTable');
    tbody.innerHTML = '';

    if (!filteredLeads.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">No customers found</td></tr>`;
        return;
    }

    filteredLeads.forEach(l => {
        tbody.innerHTML += `
            <tr>
                <td class="ps-4">
                    <input type="checkbox" class="lead-check" value="${l.psid}">
                </td>
                <td>${escapeHtml(l.full_name || '')}</td>
                <td class="small text-muted">${escapeHtml(l.page_username || '')}</td>
            </tr>`;
    });
}

function toggleAll(el) {
    document.querySelectorAll('.lead-check').forEach(c => c.checked = el.checked);
}

/* IMAGE PREVIEW */
document.getElementById('imageInput').addEventListener('change', e => {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    [...e.target.files].forEach(file => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.height = '60px';
        img.className = 'rounded border';
        preview.appendChild(img);
    });
});

/* SEND */
async function sendBroadcast() {
    const mode = document.querySelector('input[name="sendMode"]:checked').value;
    const message = document.getElementById('messageContent').value;

    const selected = [...document.querySelectorAll('.lead-check:checked')]
        .map(c => c.value);

    if (mode === 'selected' && !selected.length) {
        alert('Please select at least one customer');
        return;
    }

    const res = await fetch('/api/pancake/broadcast/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            message: message,
            lead_ids: selected,
            send_all: mode === 'all'
        })
    });

    const data = await res.json();
    showResult(data.results || []);
}

function showResult(results) {
    const list = document.getElementById('resultList');
    list.innerHTML = '';
    results.forEach(r => {
        const status = r.status || 'unknown';
        const color = status === 'success' ? 'text-success' : (status === 'skipped' ? 'text-warning' : 'text-danger');
        const reason = r.reason ? ` - ${r.reason}` : (r.error ? ` - ${r.error}` : '');
        list.innerHTML += `
            <li class="list-group-item d-flex justify-content-between">
                <span>${escapeHtml(r.psid || '')}</span>
                <span class="${color}">${escapeHtml(status)}${escapeHtml(reason)}</span>
            </li>`;
    });

    new bootstrap.Modal(document.getElementById('resultModal')).show();
}

/* tiny helper to avoid HTML injection */
function escapeHtml(str) {
    return String(str || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
}
</script>
{% endblock %}
