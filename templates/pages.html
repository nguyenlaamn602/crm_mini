{% extends "base.html" %}
{% block title %}Central Lead System{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <header class="mb-5 d-flex justify-content-between align-items-center">
        <h1 class="fw-bold text-dark">Lead Dashboard</h1>
        
        <!-- ‚úÖ Button Update Telegram -->
        <button class="btn btn-outline-primary rounded-pill btn-sm" data-bs-toggle="modal" data-bs-target="#telegramModal">
            <i class="bi bi-telegram me-1"></i> Connect Telegram
        </button>
    </header>

    <div class="row g-4 mb-5">
        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm p-4 rounded-4 h-100" style="border-left: 5px solid #4361ee !important; cursor: pointer;" onclick="location.href='/sector/Pod_Drop'">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-3 text-primary me-3">
                        <i class="bi bi-box-seam fs-3"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Pod / Drop</h5>
                </div>
                <div class="display-5 fw-bold text-primary mb-1">{{ stats.pod_drop }}</div>
                <div class="text-muted small">Total Customers</div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm p-4 rounded-4 h-100" style="border-left: 5px solid #0ea5e9 !important; cursor: pointer;" onclick="location.href='/sector/Express'">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-info bg-opacity-10 p-3 rounded-3 text-info me-3">
                        <i class="bi bi-lightning-charge fs-3"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Express</h5>
                </div>
                <div class="display-5 fw-bold text-info mb-1">{{ stats.express }}</div>
                <div class="text-muted small">Total Customers</div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6">
            <div class="card border-0 shadow-sm p-4 rounded-4 h-100" style="border-left: 5px solid #10b981 !important; cursor: pointer;" onclick="location.href='/sector/Warehouse'">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success bg-opacity-10 p-3 rounded-3 text-success me-3">
                        <i class="bi bi-house-door fs-3"></i>
                    </div>
                    <h5 class="mb-0 fw-bold">Warehouse</h5>
                </div>
                <div class="display-5 fw-bold text-success mb-1">{{ stats.warehouse }}</div>
                <div class="text-muted small">Total Customers</div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ TEAM PERFORMANCE CHART - HIDDEN FOR USERS -->
    {% if current_user.role in ['superadmin', 'admin'] %}
    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h5 class="fw-bold mb-0">üìä Team Task Performance</h5>
            
            <!-- ‚úÖ CHART FILTER BUTTONS -->
            <div class="btn-group btn-group-sm shadow-sm" role="group">
                <button type="button" class="btn btn-outline-secondary active fw-bold" onclick="filterChart('All', this)">All</button>
                {% for dept in departments %}
                <button type="button" class="btn btn-outline-secondary fw-bold" onclick="filterChart('{{ dept }}', this)">{{ dept }}</button>
                {% endfor %}
            </div>
        </div>
        
        <div class="card-body p-4">
            <!-- Container c·ªßa Chart: Fixed Height -->
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="teamTaskChart"></canvas>
                
                <!-- Hi·ªÉn th·ªã khi kh√¥ng c√≥ data -->
                <div id="noDataMessage" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #aaa;">
                    <i class="bi bi-bar-chart fs-1"></i>
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu task cho ph√≤ng ban n√†y</p>
                </div>
            </div>
            
            <div class="text-center text-muted small mt-2 fst-italic">
                <i class="bi bi-info-circle me-1"></i> Click v√†o c·ªôt ho·∫∑c t√™n nh√¢n vi√™n ƒë·ªÉ xem chi ti·∫øt
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- ‚úÖ Telegram Modal -->
<div class="modal fade" id="telegramModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-telegram me-2"></i>Telegram Notification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/user/update-telegram" method="POST">
                <div class="modal-body p-4">
                    <div class="alert alert-light border small text-muted mb-3">
                        <strong>H∆∞·ªõng d·∫´n:</strong><br>
                        1. Chat v·ªõi Bot: <a href="https://t.me/userinfobot" target="_blank" class="fw-bold">@userinfobot</a><br>
                        2. Copy d√≤ng "Id" (s·ªë)<br>
                        3. D√°n v√†o √¥ b√™n d∆∞·ªõi
                    </div>
                    <label class="form-label fw-bold text-muted small">YOUR TELEGRAM CHAT ID</label>
                    <input type="text" name="telegram_id" class="form-control rounded-3" 
                           value="{{ current_user.telegram_chat_id or '' }}" 
                           placeholder="Ex: 123456789">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4">Update ID</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
    <div id="syncToast" class="toast align-items-center text-white bg-dark border-0 shadow-lg" role="alert">
        <div class="d-flex p-2">
            <div class="toast-body">‚ú® System automatically updated data!</div>
        </div>
    </div>
</div>

<!-- ‚úÖ SAFE DATA INJECTION -->
<script>
    // Nh·∫≠n d·ªØ li·ªáu t·ª´ Flask
    const SERVER_DATA = {{ user_task_stats | tojson | safe }} || [];
</script>

<!-- ‚úÖ CHART.JS VERSION 3.9.1 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // Global Chart Instance
    let myTeamChart = null;

    document.addEventListener("DOMContentLoaded", function() {
        // Initial Render: Show All (Only if chart exists i.e. user is admin)
        if (document.getElementById('teamTaskChart')) {
            renderChart(SERVER_DATA);
        }
    });

    // ‚úÖ H√†m v·∫Ω bi·ªÉu ƒë·ªì (T√°i s·ª≠ d·ª•ng cho Filter)
    function renderChart(dataToRender) {
        const ctxElement = document.getElementById('teamTaskChart');
        if (!ctxElement) return; // Exit if element doesn't exist (user role)

        const noDataEl = document.getElementById('noDataMessage');

        // Check No Data
        if (!dataToRender || dataToRender.length === 0) {
            if (noDataEl) noDataEl.style.display = 'block';
            if (myTeamChart) {
                myTeamChart.destroy();
                myTeamChart = null;
            }
            return;
        } else {
            if (noDataEl) noDataEl.style.display = 'none';
        }

        // Destroy old chart if exists
        if (myTeamChart) {
            myTeamChart.destroy();
        }

        if (ctxElement) {
            const ctx = ctxElement.getContext('2d');
            
            myTeamChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dataToRender.map(u => u.username),
                    datasets: [
                        {
                            label: 'Cus Task (Done)',
                            data: dataToRender.map(u => u.cus_done),
                            backgroundColor: '#198754', // Green
                            stack: 'customer',
                            barPercentage: 0.8,      // ‚úÖ D√†y h∆°n (c≈© 0.6)
                            categoryPercentage: 0.9  // ‚úÖ S√°t nhau h∆°n
                        },
                        {
                            label: 'Cus Task (Pending)',
                            data: dataToRender.map(u => u.cus_not),
                            backgroundColor: '#dc3545', // Red
                            stack: 'customer',
                            barPercentage: 0.8,
                            categoryPercentage: 0.9
                        },
                        {
                            label: 'Corp Task (Done)',
                            data: dataToRender.map(u => u.corp_done),
                            backgroundColor: '#20c997', // Teal
                            stack: 'corp',
                            barPercentage: 0.8,
                            categoryPercentage: 0.9,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        {
                            label: 'Corp Task (Pending)',
                            data: dataToRender.map(u => u.corp_not),
                            backgroundColor: '#fd7e14', // Orange
                            stack: 'corp',
                            barPercentage: 0.8,
                            categoryPercentage: 0.9,
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: { 
                            stacked: false, 
                            grid: { display: false },
                            ticks: {
                                font: { weight: 'bold' }, // T√™n ƒë·∫≠m l√™n
                                cursor: 'pointer'
                            }
                        },
                        y: { 
                            stacked: true, 
                            beginAtZero: true,
                            ticks: { stepSize: 1, precision: 0 } 
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                title: function(context) { return context[0].label; }
                            }
                        }
                    },
                    // ‚úÖ Handle Hover ƒë·ªÉ hi·ªán con tr·ªè pointer
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        // Logic x·ª≠ l√Ω hover l√™n label tr·ª•c X ƒë·ªÉ hi·ªán pointer
                        const points = myTeamChart.getElementsAtEventForMode(event, 'nearest', { intersect: false, axis: 'x' }, true);
                        if (points.length) event.native.target.style.cursor = 'pointer';
                    },
                    // ‚úÖ X·ª≠ l√Ω Click (C·ªôt & T√™n)
                    onClick: (e) => {
                        const chart = myTeamChart;
                        let dataIndex = null;

                        // 1. Th·ª≠ l·∫•y ph·∫ßn t·ª≠ t·∫°i ƒëi·ªÉm click (active elements - c·ªôt)
                        const activeEls = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (activeEls.length > 0) {
                            dataIndex = activeEls[0].index;
                        } 
                        // 2. N·∫øu kh√¥ng tr√∫ng c·ªôt, th·ª≠ l·∫•y ph·∫ßn t·ª≠ g·∫ßn nh·∫•t theo tr·ª•c X (ƒë·ªÉ b·∫Øt click v√†o t√™n/label)
                        else {
                            const points = chart.getElementsAtEventForMode(e, 'nearest', { intersect: false, axis: 'x' }, true);
                            if (points.length) {
                                dataIndex = points[0].index;
                            }
                        }

                        // Redirect n·∫øu t√¨m th·∫•y user
                        if (dataIndex !== null) {
                            const userId = dataToRender[dataIndex].id;
                            if (userId && userId.length > 5) {
                                window.location.href = `/admin/user/detail/${userId}`;
                            }
                        }
                    }
                }
            });
        }
    }

    // ‚úÖ Filter Function (√Åp d·ª•ng tr·ª±c ti·∫øp cho Chart)
    function filterChart(dept, btn) {
        // UI Active State
        const buttons = btn.parentElement.querySelectorAll('.btn');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Logic Filter Data
        let filteredData = [];
        if (dept === 'All') {
            filteredData = SERVER_DATA;
        } else {
            filteredData = SERVER_DATA.filter(u => u.department === dept);
        }

        // V·∫Ω l·∫°i chart
        renderChart(filteredData);
    }

    // Sync logic Toast
    let lastSync = 0;
    const toastEl = document.getElementById('syncToast');
    if(toastEl){
        const toast = new bootstrap.Toast(toastEl);
        setInterval(() => {
            fetch('/sync-status').then(r => r.json()).then(data => {
                if (lastSync !== 0 && data.last_sync !== lastSync) {
                    toast.show();
                    setTimeout(() => location.reload(), 3000);
                }
                lastSync = data.last_sync;
            });
        }, 30000);
    }
</script>

<style>
    .hover-shadow:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .transition {
        transition: all 0.2s ease-in-out;
    }
    /* Con tr·ªè chu·ªôt khi hover v√†o canvas ƒë·ªÉ bi·∫øt l√† click ƒë∆∞·ª£c */
    #teamTaskChart {
        cursor: pointer;
    }
</style>
{% endblock %}