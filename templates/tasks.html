{% extends "base.html" %}
{% block title %}Task Management - THG{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-4 rounded-4 shadow-sm">
        <div>
            <h4 class="mb-1 fw-bold text-dark">ðŸ“‹ Task Management Dashboard</h4>
            <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm mt-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="bi bi-plus-lg me-1"></i> Add New Task
            </button>
        </div>
        
        <form action="/tasks" method="GET" class="d-flex gap-3">
            <div class="input-group input-group-sm bg-light rounded-pill px-3 py-1 border-0" style="width: 300px;">
                <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
                <input type="text" name="search" class="form-control border-0 bg-transparent" 
                       placeholder="Search content or customer..." value="{{ request.args.get('search', '') }}">
            </div>
            
            <select name="status" class="form-select form-select-sm bg-light border-0 rounded-pill px-4" onchange="this.form.submit()" style="width: 160px;">
                <option value="">-- All Statuses --</option>
                <option value="Not_yet" {% if request.args.get('status') == 'Not_yet' %}selected{% endif %}>Not yet</option>
                <option value="Done" {% if request.args.get('status') == 'Done' %}selected{% endif %}>Done</option>
                <option value="Missed" {% if request.args.get('status') == 'Missed' %}selected{% endif %}>Missed</option>
            </select>
        </form>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover bg-white">
                <thead class="bg-light text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.05rem;">
                    <tr>
                        <th class="ps-4 py-3 text-muted" style="width: 60px;">NO.</th>
                        <th class="text-muted" style="max-width: 400px;">TODO CONTENT</th>
                        <th class="text-muted">TIME (UTC+7)</th>
                        <th class="text-muted">ASSIGNEE</th>
                        <th class="text-center text-muted">STATUS</th>
                        <th class="pe-4 text-end text-muted">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="ps-4">
                            <span class="text-muted fw-bold">{{ loop.index }}</span>
                        </td>
                        <td class="py-3" style="max-width: 400px;">
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-dark" style="font-size: 0.95rem; line-height: 1.3;">
                                    {{ task.todo_content }}
                                </span>
                                <span class="text-muted" style="font-size: 0.75rem; margin-top: 2px;">
                                    <i class="bi bi-person-vcard me-1"></i>{{ task.customer_name if task.customer_name else 'N/A' }}
                                </span>
                            </div>
                        </td>
                        <td class="small text-secondary fw-medium">
                            <i class="bi bi-clock-history me-1"></i>{{ task.updated_at.strftime('%H:%M %d/%m') if task.updated_at else '---' }}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 28px; height: 28px; font-size: 0.8rem; font-weight: bold;">
                                    {{ task.assignee[0].upper() if task.assignee and task.assignee != '---' else '?' }}
                                </div>
                                <span class="small fw-semibold text-dark">{{ task.assignee }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn p-0 border-0 shadow-none status-toggle-btn" 
                                    onclick="toggleTaskStatus(this, '{{ task.id }}', '{{ task.status }}')">
                                {% if task.status == 'Done' %}
                                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2">Done</span>
                                {% elif task.status == 'Missed' %}
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3 py-2">Missed</span>
                                {% else %}
                                    <span class="badge bg-info-subtle text-info border border-info-subtle rounded-pill px-3 py-2">Not yet</span>
                                {% endif %}
                            </button>
                        </td>
                        <td class="pe-4 text-end">
                            <div class="dropdown">
                                <button class="btn btn-link text-muted p-0 shadow-none" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical fs-5"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow rounded-3 p-2">
                                    <li>
                                        <button class="dropdown-item rounded-2" data-bs-toggle="modal" data-bs-target="#editTask{{ task.id }}">
                                            <i class="bi bi-pencil me-2"></i>Edit
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form action="/task/delete/{{ task.id }}" method="POST" onsubmit="return confirm('Delete this task?');" class="m-0">
                                            <button type="submit" class="dropdown-item text-danger rounded-2">
                                                <i class="bi bi-trash me-2"></i>Delete
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% for task in tasks %}
<div class="modal fade" id="editTask{{ task.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-primary text-white py-3 px-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i> Edit Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/task/update/{{ task.id }}" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">TODO CONTENT</label>
                        <textarea name="todo_content" class="form-control rounded-3" rows="3" required>{{ task.todo_content }}</textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small">ASSIGNEE</label>
                            {% if current_user.role == 'admin' %}
                            <select name="assigned_user_id" class="form-select rounded-3">
                                {% for u in users_list %}
                                <option value="{{ u._id }}" {% if task.assigned_to|string == u._id|string %}selected{% endif %}>
                                    {{ u.username }}
                                </option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="text" class="form-control rounded-3 bg-light" value="{{ task.assignee }}" readonly disabled>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small">STATUS</label>
                            <select name="status" class="form-select rounded-3">
                                <option value="Not_yet" {% if task.status == 'Not_yet' %}selected{% endif %}>Not yet</option>
                                <option value="Done" {% if task.status == 'Done' %}selected{% endif %}>Done</option>
                                <option value="Missed" {% if task.status == 'Missed' %}selected{% endif %}>Missed</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light px-4 py-3">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-modal="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-primary text-white py-3 px-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i> Create Manual Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/task/add" method="POST">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">TODO CONTENT</label>
                        <textarea name="todo_content" class="form-control rounded-3" rows="3" required placeholder="What needs to be done?"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">CUSTOMER NAME</label>
                        <input type="text" name="customer_name" class="form-control rounded-3" placeholder="Enter name...">
                    </div>
                    
                    {% if current_user.role == 'admin' %}
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">ASSIGN TO STAFF</label>
                        <select name="assigned_user_id" class="form-select rounded-3">
                            {% for u in users_list %}
                            <option value="{{ u._id }}" {% if u._id|string == current_user.id|string %}selected{% endif %}>
                                {{ u.username }} {% if u._id|string == current_user.id|string %}(You){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small">CREATOR</label>
                            <input type="text" class="form-control rounded-3 bg-light" value="{{ current_user.username }}" readonly disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small">STATUS</label>
                            <select name="status" class="form-select rounded-3">
                                <option value="Not_yet">Not yet</option>
                                <option value="Done">Done</option>
                                <option value="Missed">Missed</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label fw-bold text-muted small">TIME (LOG)</label>
                        <input type="text" name="time_log" class="form-control rounded-3" placeholder="e.g. 25/12 10:00">
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light px-4 py-3">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">Create Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    async function toggleTaskStatus(button, taskId, currentStatus) {
        let nextStatus = 'Not_yet';
        if (currentStatus === 'Not_yet' || currentStatus === 'New') nextStatus = 'Done';
        else if (currentStatus === 'Done') nextStatus = 'Missed';
        
        button.style.opacity = '0.5';
        button.disabled = true;
        const formData = new FormData();
        formData.append('status', nextStatus);
        try {
            const response = await fetch(`/task/quick-update/${taskId}`, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const result = await response.json();
            if (result.status === 'success') {
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            button.style.opacity = '1';
            button.disabled = false;
        }
    }
</script>

<style>
    .status-toggle-btn { transition: transform 0.15s ease; cursor: pointer; }
    .status-toggle-btn:hover { transform: scale(1.05); }
    .table-hover tbody tr:hover { background-color: #f8faff !important; }
    .badge { font-weight: 600; font-size: 0.75rem; }
</style>
{% endblock %}