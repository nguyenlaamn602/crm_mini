{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
            <h5 class="mb-0">üîå Pancake Bulk CRM (test)</h5>
            <span class="badge bg-primary">User Token Active</span>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="fw-bold">1. Ch·ªçn Fanpage</label>
                    <select id="pageSelect" class="form-select" onchange="loadConversations()">
                        <option value="">-- ƒêang t·∫£i danh s√°ch Page... --</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="fw-bold">2. L·ªçc kh√°ch h√†ng (Kh√¥ng m·∫•t tick ch·ªçn)</label>
                    <input type="text" id="tableSearch" class="form-control" placeholder="T√¨m t√™n kh√°ch h√†ng..." onkeyup="filterTable()">
                </div>
            </div>

            <div class="table-responsive border rounded" style="max-height: 400px;">
                <table class="table table-hover align-middle">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
                            <th>T√™n kh√°ch h√†ng</th>
                            <th>ID H·ªôi tho·∫°i</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="convoBody">
                        <tr><td colspan="4" class="text-center">H√£y ch·ªçn Fanpage ƒë·ªÉ b·∫Øt ƒë·∫ßu</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 p-3 bg-light border rounded">
                <h6 class="fw-bold">üí¨ G·ª≠i tin nh·∫Øn h√†ng lo·∫°t (<span id="countSelected">0</span> ng∆∞·ªùi)</h6>
                <div id="namePreview" class="small text-muted mb-2"></div>
                <textarea id="msgBody" class="form-control mb-2" rows="3" placeholder="N·ªôi dung tin nh·∫Øn..."></textarea>
                <input type="file" id="msgImage" class="form-control mb-2">
                <button class="btn btn-primary w-100" id="sendBtn" onclick="sendBulk()">üöÄ B·∫Øt ƒë·∫ßu g·ª≠i ngay</button>
            </div>
        </div>
    </div>
</div>

<script>
let allConvos = [];
let selectedItems = new Map(); // ID -> Name
let currentPageToken = "";

// Load danh s√°ch Page khi m·ªü trang
fetch('/api/secret/get-pages')
    .then(r => r.json())
    .then(data => {
        const select = document.getElementById('pageSelect');
        select.innerHTML = '<option value="">-- Ch·ªçn Fanpage --</option>';
        data.pages.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
    });

async function loadConversations() {
    const pageId = document.getElementById('pageSelect').value;
    if(!pageId) return;
    const tbody = document.getElementById('convoBody');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center">ƒêang t·∫£i kh√°ch h√†ng tr·ª±c ti·∫øp...</td></tr>';
    
    const r = await fetch(`/api/secret/get-conversations/${pageId}`);
    const data = await r.json();
    allConvos = data.conversations;
    currentPageToken = data.page_token;
    renderTable(allConvos);
}

function renderTable(data) {
    const tbody = document.getElementById('convoBody');
    tbody.innerHTML = data.map(c => {
        const name = c.customers?.[0]?.name || c.participants?.[0]?.name || "·∫®n danh";
        return `
        <tr>
            <td><input type="checkbox" value="${c.id}" data-name="${name}" onchange="syncCheck(this)" ${selectedItems.has(c.id) ? 'checked' : ''}></td>
            <td>${name}</td>
            <td><code>${c.id}</code></td>
            <td>${c.inserted_at || ''}</td>
        </tr>`;
    }).join('');
}

function filterTable() {
    const q = document.getElementById('tableSearch').value.toLowerCase();
    const filtered = allConvos.filter(c => {
        const name = (c.customers?.[0]?.name || c.participants?.[0]?.name || "").toLowerCase();
        return name.includes(q);
    });
    renderTable(filtered);
}

function syncCheck(cb) {
    if(cb.checked) selectedItems.set(cb.value, cb.getAttribute('data-name'));
    else selectedItems.delete(cb.value);
    
    document.getElementById('countSelected').innerText = selectedItems.size;
    document.getElementById('namePreview').innerText = Array.from(selectedItems.values()).join(", ");
}

function toggleAll(master) {
    document.querySelectorAll('#convoBody input[type="checkbox"]').forEach(cb => {
        cb.checked = master.checked;
        syncCheck(cb);
    });
}

async function sendBulk() {
    const ids = Array.from(selectedItems.keys());
    if(ids.length === 0) return alert("Ch·ªçn √≠t nh·∫•t 1 ng∆∞·ªùi!");
    
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.innerText = "ƒêang g·ª≠i...";

    const formData = new FormData();
    formData.append('page_id', document.getElementById('pageSelect').value);
    formData.append('page_token', currentPageToken);
    formData.append('message', document.getElementById('msgBody').value);
    ids.forEach(id => formData.append('ids[]', id));
    
    const img = document.getElementById('msgImage').files[0];
    if(img) formData.append('image', img);

    const r = await fetch('/api/secret/bulk-send', { method: 'POST', body: formData });
    const res = await r.json();
    
    alert(`ƒê√£ g·ª≠i th√†nh c√¥ng cho ${res.success}/${res.total} kh√°ch h√†ng!`);
    btn.disabled = false;
    btn.innerText = "üöÄ B·∫Øt ƒë·∫ßu g·ª≠i ngay";
}
</script>
{% endblock %}